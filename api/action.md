---
title: Action
description: Справочник по методам и свойствам действия
outline: deep
---

## Action

**Файл:** `src/action.ts`

Класс, представляющий действие (декорированный метод) с возможностями управления состоянием.

### Статические свойства

#### `Action.possibleState`

Объект, содержащий все возможные состояния действия:

```typescript
{
  pending: 'pending',
  error: 'error',
  lock: 'lock',
  ready: 'ready',
  abort: 'abort'
}
```

#### `Action.actionFlag`

Символ, используемый для пометки методов как действий: `Symbol('__action_original_method__')`

#### `Action.abortedByLock`

Символ, используемый как причина прерывания при блокировке действия: `Symbol('lock')`

### Статические методы

#### `Action.create<T, Args>(model, actionFunction, ownerGetter, setStateCb, validateArgs): ActionLike<T, Args>`

Фабричный метод для создания нового экземпляра Action.

**Параметры:**

- `model` - Экземпляр ProtoModel
- `actionFunction` - Обёрнутый оригинальный метод
- `ownerGetter` - Функция, возвращающая экземпляр Model
- `setStateCb` - Callback для обновления состояния действия в модели
- `validateArgs` - Функция для валидации аргументов действия

**Возвращает:** Реактивный экземпляр ActionLike

### Свойства экземпляра

#### `name: string` (только чтение)

Имя действия (имя метода).

#### `owner: Model<T>` (только чтение)

Экземпляр модели, которому принадлежит это действие.

#### `possibleStates: ActionStateName[]` (только чтение)

Массив всех возможных имён состояний для действий.

#### `state: ActionStateName` (только чтение)

Текущее состояние действия. Одно из: `'pending'`, `'error'`, `'lock'`, `'ready'`, `'abort'`.

#### `abortController: AbortController | null` (только чтение)

Экземпляр AbortController, если действие находится в состоянии pending, иначе `null`.

#### `args: Args | never[]` (только чтение)

Аргументы, переданные при последнем выполнении действия.

#### `promise: Promise<void> | null` (только чтение)

Промис текущего выполнения, если действие находится в состоянии pending, иначе `null`.

#### `error: ActionError | null` (только чтение)

Экземпляр ActionError, если действие находится в состоянии error, иначе `null`.

#### `abortReason: unknown` (только чтение)

Причина прерывания, если действие прервано, иначе `null`.

#### `isPending: boolean` (только чтение)

Возвращает `true`, если действие находится в состоянии pending.

#### `isError: boolean` (только чтение)

Возвращает `true`, если действие находится в состоянии error.

#### `isReady: boolean` (только чтение)

Возвращает `true`, если действие находится в состоянии ready.

#### `isLock: boolean` (только чтение)

Возвращает `true`, если действие находится в состоянии lock.

#### `isAbort: boolean` (только чтение)

Возвращает `true`, если действие находится в состоянии abort.

### Методы экземпляра

#### `is(...args: ActionStateName[]): boolean`

Проверяет, находится ли действие в любом из указанных состояний.

**Параметры:**

- `...args` - Имена состояний для проверки

**Возвращает:** `true` если действие находится в любом из указанных состояний

**Пример:**

```typescript
if (action.is('pending', 'lock')) {
  // Действие либо pending, либо заблокировано
}
```

#### `validate(...args: Args): Error[]`

Валидирует аргументы действия.

**Параметры:**

- `...args` - Аргументы для валидации

**Возвращает:** Массив ошибок валидации (пустой, если валидно)

**Пример:**

```typescript
const errors = action.validate('arg1', 'arg2')
if (errors.length > 0) {
  // Обработать ошибки валидации
}
```

#### `exec(...args: Args): Promise<void>`

Выполняет действие и переводит его в состояние pending.

**Параметры:**

- `...args` - Аргументы для передачи в метод действия
  - Если последний аргумент является `AbortController`, он будет использован
  - Иначе будет создан новый `AbortController` и добавлен в конец

**Возвращает:** Промис, который разрешается при завершении действия

**Выбрасывает:**

- `ActionStatusConflictError` если действие уже находится в состоянии `lock` или `pending`
- Различные ошибки, если метод действия выбрасывает исключение (обёрнутое в ActionError)

**Поведение:**

- Устанавливает состояние действия в `pending` перед выполнением
- Если метод возвращает не-Promise, немедленно устанавливает состояние в `ready`
- Если метод возвращает Promise:
  - При успехе: устанавливает состояние в `ready`
  - При ошибке: оборачивает ошибку в `ActionError` и устанавливает состояние в `error`
  - При прерывании: устанавливает состояние в `abort` или `lock` (если прервано блокировкой)

**Пример:**

```typescript
await action.exec('arg1', 'arg2')
if (action.error) {
  console.error(action.error.cause)
}
```

#### `abort(reason?: unknown): Promise<void>`

Прерывает текущее выполнение действия, если оно находится в состоянии pending.

**Параметры:**

- `reason` - Опциональная причина прерывания

**Возвращает:** Промис, который отклоняется с причиной прерывания

**Примечание:** Возвращает разрешённый промис, если действие не находится в состоянии pending

**Пример:**

```typescript
const promise = action.exec()
action.abort('Пользователь отменил')
await promise.catch(() => {
  // Обработать прерывание
})
```

#### `lock(): Promise<void>`

Блокирует действие, предотвращая дальнейшее выполнение. Если действие находится в состоянии pending, оно будет прервано с причиной `Action.abortedByLock`.

**Возвращает:** Промис, который разрешается при применении блокировки

**Поведение:**

- Если pending: прерывает с причиной блокировки, затем устанавливает состояние в `lock`
- Если не pending: немедленно устанавливает состояние в `lock`

**Пример:**

```typescript
await action.lock()
// Действие теперь заблокировано и не может быть выполнено
```

#### `unlock(): this`

Разблокирует действие и устанавливает его в состояние ready.

**Возвращает:** Экземпляр действия (для цепочки вызовов)

**Выбрасывает:** `ActionStatusConflictError` если действие не находится в состоянии lock

**Пример:**

```typescript
action.unlock()
// Действие теперь готово и может быть выполнено
```

#### `resetError(): this`

Сбрасывает состояние ошибки и устанавливает действие в состояние ready.

**Возвращает:** Экземпляр действия (для цепочки вызовов)

**Выбрасывает:** `ActionStatusConflictError` если действие не находится в состоянии error

**Пример:**

```typescript
if (action.error) {
  action.resetError()
  // Действие теперь готово
}
```

#### `toString(): string`

Возвращает имя действия в виде строки.

**Возвращает:** Имя действия
